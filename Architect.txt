# 🏗️ Полная архитектура MudMind Alpha 0.1: Потоки данных

          [MUD СЕРВЕР] (Внешний)
                 │
           TCP/Telnet
         (сырой текст, байты)
                 │
                 ▼
    ┌─────────────────────────────┐
    │  MudClient (Слой транспорта) │
    │  • Async TCP-клиент         │
    │  • Декодирование CP866/UTF-8│
    │  • Очистка ANSI-кодов       │
    │  • Разделение на строки     │
    └─────────────┬───────────────┘
                  │ MudLineReceived(текст, время)
                  ▼
    ┌─────────────────────────────┐
    │     EventBus (Ядро системы) │
    │  ┌───────────────────────┐  │
    │  │   ВСЕ события → ВСЕМ  │  │
    │  │   подписчикам         │  │
    │  └───────────────────────┘  │
    └─────────────┬───────────────┘
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
┌──────────────┐   ┌─────────────────┐
│   GUI        │   │   Parser        │
│   Слой       │   │   (Парсер)      │
│   отображения│   └────────┬────────┘
└──────┬───────┘            │
       │              ParsedDataEvent(сущности)
       │                    │
       │                    ▼
       │          ┌─────────────────┐
       │          │ StateManager    │
       │          │ (Менеджер       │
       │          │  состояния)     │
       │          └────────┬────────┘
       │                   │ StateUpdatedEvent(дельта)
       │                   ▼
       │          ┌─────────────────┐
       │          │   Classifier    │
       │          │ (Классификатор  │
       │          │   ситуаций)     │
       │          └────────┬────────┘
       │                   │ SituationFlags(флаги)
       │                   ▼
       │          ┌─────────────────┐
       │          │   RuleEngine    │
       │          │ (Движок правил) │
       │          └────────┬────────┘
       │                   │ ActivatedRules(правила, приоритет)
       │                   ▼
       │          ┌─────────────────┐
       │          │ PromptBuilder   │
       │          │ (Сборщик        │
       │          │  промптов)      │
       │          └────────┬────────┘
       │                   │ PromptForAI(промпт, контекст)
       │                   ▼
       │          ┌─────────────────┐
       │          │   MicroModel    │
       │          │ (Vikhr-Qwen)    │
       │          └────────┬────────┘
       │                   │ RawAIResponse(сырой ответ)
       │                   ▼
       │          ┌─────────────────┐
       │          │ ResponseParser  │
       │          │ (Валидатор      │
       │          │  ответа)        │
       │          └────────┬────────┘
       │                   │ ValidatedCommands(3 команды)
       │                   ▼
       │          ┌─────────────────┐
       │          │ CommandSequencer│
       │          │ (Диспетчер      │
       │          │  очереди)       │
       │          └────────┬────────┘
       │                   │
       │            ┌──────┴──────┐
       │            ▼             ▼
       │    ┌─────────────┐ ┌─────────────┐
       │    │  Критический│ │  Обычный    │
       │    │  приоритет? │ │  приоритет? │
       │    └──────┬──────┘ └──────┬──────┘
       │           │               │
       │           ▼               ▼
       │    ┌─────────────┐ ┌─────────────┐
       │    │Auto-Command │ │Suggestions- │
       │    │  (событие)  │ │ ReadyEvent  │
       │    └──────┬──────┘ └──────┬──────┘
       │           │               │
       │           └───────┬───────┘
       │                   │
       │                   ▼
       │          ┌─────────────────┐
       │          │    EventBus     │
       │          │   (снова)       │
       │          └────────┬────────┘
       │         ┌─────────┴─────────┐
       │         ▼                   ▼
       │  ┌─────────────┐   ┌─────────────┐
       │  │   Sequencer │   │     GUI     │
       │  │   отправляет│   │  отображает │
       │  │   команду   │   │  3 варианта │
       │  └──────┬──────┘   └──────┬──────┘
       │         │                  │
       │         ▼                  │ UserChoiceEvent
       │  ┌─────────────┐          │ (выбор/ввод игрока)
       │  │  MudClient  │          │
       │  │  отправляет │◄─────────┘
       │  │  команду    │
       │  └──────┬──────┘
       │         │
       │         ▼
       │    [MUD СЕРВЕР]
       │         │
       │         ▼ (ответ)
       │   MudLineReceived
       │    (цикл повторяется)


## 🔄 Детализация внутренних потоков данных

### Поток 1: От сырого текста к структурированному состоянию


MUD → "HP: 45/100. Вы упали. Лежит меч."
        │
        ▼
[MudClient] → MudLineReceived("HP: 45/100...")
                      │
                      ▼
                 [Parser]
                      │ (триггер: ключевые слова)
                      ▼
           ParsedDataEvent({
             hp: {current:45, max:100, percent:45},
             position: "prone",
             room_items: ["меч"]
           })
                      │
                      ▼
             [StateManager]
                      │
         Немедленное обновление:
           • hp_current = 45
           • position = "prone"
           • hp_percent = 45
                      │
           StateUpdatedEvent({
             hp_delta: -55,
             position_changed: "standing→prone"
           })


### Поток 2: От состояния к диагнозу и правилам


[StateManager] → Текущее состояние
        │
        ▼
  [Classifier] → Флаги:
        • in_combat = true
        • low_health = true (45% < 70%)
        • prone = true
        │
        ▼
  [RuleEngine] → Проверка user_rules.json
        │
        ▼ (активация правила "combat_prone")
 ActivatedRulesEvent({
   rule_id: "combat_prone",
   priority: "CRITICAL",
   condition: "in_combat AND prone AND low_health",
   suggested_actions: ["встать", "щит", "бежать"]
 })


### Поток 3: От диагноза к промпту и генерации


ActivatedRulesEvent → [PromptBuilder]
        │
        ▼ (сбор контекста)
 PromptForAI({
   system: "Ты помощник в MUD...",
   context: "HP: 45%, prone, in_combat...",
   active_rules: "CRITICAL: combat_prone...",
   constraints: "Только 3 команды, 1-2 слова...",
   format: "1. ...\n2. ...\n3. ..."
 })
        │
        ▼
   [MicroModel] (Vikhr-Qwen-2.5-0.5b)
        │
        ▼ (temperature=0.3, max_tokens=50)
 RawAIResponse("1. встать\n2. щит\n3. бежать север")
        │
        ▼
 [ResponseParser] → Валидация по белому списку
        │
        ▼
 ValidatedCommands(["встать", "щит", "бежать север"])


### Поток 4: Управление очередью и приоритетами


ValidatedCommands → [CommandSequencer]
        │
        ▼ (оценка приоритета "CRITICAL")
        ├── Приоритет = CRITICAL?
        │       │
        │       ▼ (да)
        │   • Проверка текущей команды
        │   • Если можно отменить → "\n"
        │   • Очистка очереди
        │       │
        │       ▼
        │   AutoCommandEvent("встать")
        │       │
        │       ▼
        │   [EventBus] → [Sequencer]
        │       │
        │       ▼
        │   [Sequencer] → отправка "встать"
        │       │
        │       ▼
        │   [MudClient] → "встать"
        │
        ▼ (нет → приоритет HIGH/MEDIUM/LOW)
   SuggestionsReadyEvent({
     commands: ["встать", "щит", "бежать"],
     priority: "CRITICAL",
     source: "micro_model"
   })
        │
        ▼
   [EventBus] → [GUI] (правая панель)
        │
        ▼
   [GUI] → отображение 3 вариантов
        │
        ▼ (игрок выбирает/таймаут 5с)
   UserChoiceEvent("щит")  или AutoChoiceEvent("встать")
        │
        ▼
   [EventBus] → [Sequencer] → отправка команды


### Поток 5: Обратная связь и адаптация


[MUD] → "Вы поднялись на ноги" / "Не можете сейчас"
        │
        ▼
   MudLineReceived(...)
        │
        ▼
   [Parser] → prone = false / ошибка
        │
        ▼
   [StateManager] → обновление состояния
        │
        ▼
   KnowledgeBase.learn(context, command, result)
        │
        ▼ (успех → запомнить, неудача → избегать)
   База знаний обновляет "успешные паттерны"


## ⚙️ Специфические потоки управления

### Поток CRITICAL-прерывания


[Sequencer] → текущая_команда = "осмотреть", приоритет = MEDIUM
        │
        ▼ (поступает CRITICAL команда)
Новая_команда = "телепорт", приоритет = CRITICAL
        │
        ▼
1. Проверка: текущая_команда.отменяема?
   │
   ├─ Да → MudClient.send("\n")
   │       │
   │       ▼
   │   Очередь.очистить()
   │       │
   │       ▼
   │   Отправка "телепорт"
   │
   └─ Нет → Ждать завершения текущей
           │
           ▼
       Таймаут или ответ → Отправка "телепорт"


### Поток таймаутов выполнения


Команда "встать" → отправлена в тик 100
        │
        ▼ (таймаут = 4 тика для сложных команд)
Ожидание: тик 101, 102, 103
        │
        ▼ (тик 104 - таймаут)
Если ответ не получен:
   • Пометить как "TIMEOUT"
   • CommandFailedEvent
   • Правило "combat_prone": retry_count++
        │
        ▼ (retry_count < max_retries)
   Повтор команды или fallback


### Поток GUI приоритетной индикации


SuggestionsReadyEvent(priority: "CRITICAL")
        │
        ▼
[GUI.ai_panel] → У